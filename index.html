<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, viewport-fit=cover">
  <title>Godt Br√∏d ‚Äì Varetelling (demo)</title>
  <meta name="theme-color" content="#0a6c3c">
  <style>
    /* ===== Godt Br√∏d-inspirert tema (rolig gr√∏nn, lys, ren) ===== */
    :root{
      --gb-green:#0a6c3c;     /* prim√¶r */
      --gb-green-600:#0c7b45;
      --gb-cream:#fffdf6;     /* bakgrunn */
      --gb-ink:#1d2a21;       /* tekst */
      --muted:#6b7b70;
      --card:#ffffff;
      --ring:#d9e6db;
      --ok:#118a57;
      --warn:#b97a12;
      --err:#b4352e;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--gb-ink);
      background:
        radial-gradient(1200px 400px at 10% -5%, rgba(17,138,87,0.10), transparent 60%),
        radial-gradient(1200px 400px at 90% -10%, rgba(17,138,87,0.08), transparent 60%),
        var(--gb-cream);
    }
    header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(180deg, #ffffff, #fffdf6f2);
      border-bottom:1px solid #eef4ee;
      backdrop-filter:saturate(1.1) blur(6px);
    }
    .wrap{max-width:840px; margin:0 auto; padding:16px}
    .brand{
      display:flex; align-items:center; gap:12px; padding:8px 0;
    }
    .logo{
      width:36px; height:36px; border-radius:8px;
      background:conic-gradient(from 180deg, #0a6c3c, #21b26a, #0a6c3c);
      display:grid; place-items:center; color:#fff; font-weight:800;
      letter-spacing:0.5px;
    }
    h1{font-size:18px; margin:0}
    .sub{color:var(--muted); font-size:13px}

    .card{
      background:var(--card); border:1px solid var(--ring); border-radius:16px;
      padding:14px; box-shadow:0 10px 30px rgba(0,0,0,0.06);
    }
    .grid{display:grid; gap:12px}
    @media(min-width:720px){ .grid{grid-template-columns:1fr 1fr} }

    .section-title{font-size:15px; font-weight:700; margin:0 0 6px 0}
    .muted{color:var(--muted)}
    .hr{height:1px; background:#eef2ee; margin:10px 0}

    /* Buttons/inputs */
    button, input, select{
      font:inherit; color:inherit;
    }
    .btn{
      appearance:none; cursor:pointer;
      background:linear-gradient(180deg, #ffffff, #f9fbf9);
      border:1px solid #dce9df; color:#0a4228; padding:10px 12px;
      border-radius:12px; font-weight:600;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:linear-gradient(180deg, #16a163, #0f7e4d);
      color:#fff; border-color:#0f7e4d;
    }
    .btn.secondary{border-color:#cfe2d5}
    .btn.ghost{background:transparent}
    .btn.full{width:100%}
    .btn.danger{background:#b4352e; border-color:#8d2823; color:#fff}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap}

    .input, .select{
      width:100%; padding:12px 12px;
      background:#fff; border:1px solid #dbe8de; border-radius:12px;
      outline:none;
    }
    .input:focus, .select:focus{border-color:#21a869; box-shadow:0 0 0 3px rgba(33,168,105,.12)}

    /* Department chooser */
    .choices{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    @media(min-width:600px){ .choices{grid-template-columns:repeat(3, 1fr)}}
    .choice{
      border:1px solid #dbe8de; border-radius:12px; padding:10px;
      background:#ffffff; cursor:pointer; text-align:center; font-weight:600;
    }
    .choice:hover{border-color:#b9d6c3}
    .choice.active{background:#0f7e4d; color:#fff; border-color:#0f7e4d}

    /* Count list */
    table{width:100%; border-collapse:separate; border-spacing:0 8px}
    th, td{padding:8px 10px; text-align:left; font-size:14px}
    thead th{color:#567261; font-weight:700}
    tbody tr{background:#fff; border:1px solid #e6efe9}
    tbody tr td:first-child{border-top-left-radius:10px; border-bottom-left-radius:10px}
    tbody tr td:last-child{border-top-right-radius:10px; border-bottom-right-radius:10px}

    .qty{display:flex; align-items:center; gap:6px}
    .qty input{width:72px; text-align:right}

    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid #dbe8de; background:#f7fbf8}
    .headerbar{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}

    .hide{display:none !important}

    /* Modal for skann */
    .modal{
      position:fixed; inset:0; display:none; place-items:center;
      background:rgba(0,0,0,.5);
    }
    .modal .panel{
      width:min(680px, 94vw); background:#0b2c1e; color:#e8fff4; border-radius:16px; padding:12px;
      border:1px solid #124b31; box-shadow:0 20px 60px rgba(0,0,0,.45);
    }
    video{width:100%; border-radius:12px; background:#000}
    .scanline{position:absolute; left:10%; right:10%; height:2px; background:#21b26a; box-shadow:0 0 14px #21b26a; animation:scan 2s linear infinite}
    @keyframes scan{0%{transform:translateY(10%)} 50%{transform:translateY(380%)} 100%{transform:translateY(10%)}}
    .videoWrap{position:relative; overflow:hidden; border-radius:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand">
        <div class="logo">GB</div>
        <div>
          <h1>Varetelling</h1>
          <div class="sub">Velg avdeling ‚Üí skann eller legg inn vare manuelt</div>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap" id="app">

    <!-- Steg 1: Velg avdeling -->
    <section id="stepDept" class="card">
      <div class="section-title">Avdeling</div>
      <p class="muted" style="margin-top:0">Velg din avdeling. Du kan endre senere.</p>
      <div id="deptChoices" class="choices" aria-live="polite"></div>
      <div class="hr"></div>
      <div class="toolbar">
        <input id="deptCustom" class="input" placeholder="Egendefinert navn (valgfritt)" />
        <button id="deptConfirm" class="btn primary">Bekreft avdeling</button>
      </div>
    </section>

    <!-- Steg 2: Telling -->
    <section id="stepCount" class="card hide">
      <div class="headerbar">
        <div class="pill" id="deptPill">Avdeling: ‚Äì</div>
        <div class="toolbar">
          <button id="changeDept" class="btn ghost">Bytt avdeling</button>
          <button id="exportCsv" class="btn secondary">Last ned CSV</button>
          <button id="clearAll" class="btn danger">T√∏m liste</button>
        </div>
      </div>
      <div class="hr"></div>

      <!-- Skann / manuell -->
      <div class="grid">
        <div>
          <div class="section-title">Strekkode (valgfritt)</div>
          <div class="toolbar">
            <input id="barcode" class="input" placeholder="Skann eller skriv inn strekkode" inputmode="numeric" />
            <button id="scanBtn" class="btn">Skann med kamera</button>
          </div>
        </div>
        <div>
          <div class="section-title">Varenavn (manuelt)</div>
          <input id="name" class="input" placeholder="F.eks. √òkologisk surdeigsbr√∏d" />
        </div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div>
          <div class="section-title">Antall</div>
          <div class="qty">
            <button class="btn" id="minus">‚Äì</button>
            <input id="qty" class="input" type="number" min="0" value="1" />
            <button class="btn" id="plus">+</button>
          </div>
        </div>
        <div style="align-self:end">
          <button id="addItem" class="btn primary full">Legg til i liste</button>
        </div>
      </div>

      <div class="hr"></div>

      <!-- Liste -->
      <div class="section-title">Dagens telling</div>
      <div class="muted" style="margin-bottom:6px">Trykk p√• papirkurv for √• fjerne linje.</div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Strekkode</th>
              <th>Varenavn</th>
              <th>Antall</th>
              <th style="width:56px"></th>
            </tr>
          </thead>
          <tbody id="listBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Skannemodal -->
  <div id="scanModal" class="modal" role="dialog" aria-modal="true" aria-label="Skann strekkode">
    <div class="panel">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
        <div style="font-weight:700">Skann strekkode</div>
        <button id="closeScan" class="btn">Lukk</button>
      </div>
      <div class="videoWrap">
        <video id="video" playsinline muted></video>
        <div class="scanline"></div>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <button id="torchBtn" class="btn">Lommelykt</button>
        <div id="scanHint" class="muted">Hold koden midt i bildet.</div>
      </div>
    </div>
  </div>

  <script>
    // ===== Avdelinger (legg til/fjern etter behov) =====
    const DEFAULT_DEPTS = [
      "Marken", "Korskirken", "Vaskerelven",
      "Lagunen", "Xhibition", "Nesttun",
      "Sandviken", "Danmarksplass", "√Ösane",
      "Os", "Fana", "Voss"
    ];

    // ===== State =====
    const state = {
      department: null,
      items: []  // {id, barcode, name, qty, ts}
    };

    // ===== Helpers =====
    const $ = s => document.querySelector(s);
    const elDeptChoices = $("#deptChoices");
    const elDeptCustom = $("#deptCustom");
    const elDeptPill = $("#deptPill");
    const elStepDept = $("#stepDept");
    const elStepCount = $("#stepCount");
    const elListBody = $("#listBody");
    const elBarcode = $("#barcode");
    const elName = $("#name");
    const elQty = $("#qty");

    // Load persisted
    (function init(){
      const persistedDept = localStorage.getItem("gb_dept");
      const persistedItems = localStorage.getItem("gb_items");
      if (persistedDept) state.department = persistedDept;
      if (persistedItems) try{ state.items = JSON.parse(persistedItems) } catch {}
      renderDeptChoices();
      if (state.department) enterCounting();
      renderList();
    })();

    function renderDeptChoices(){
      elDeptChoices.innerHTML = "";
      const all = [...DEFAULT_DEPTS];
      all.forEach(name => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "choice" + (state.department === name ? " active" : "");
        b.textContent = name;
        b.onclick = ()=>{
          state.department = name;
          document.querySelectorAll(".choice").forEach(c=>c.classList.remove("active"));
          b.classList.add("active");
        };
        elDeptChoices.appendChild(b);
      });
    }

    $("#deptConfirm").onclick = ()=>{
      const custom = elDeptCustom.value.trim();
      if (custom) state.department = custom;
      if (!state.department){
        alert("Velg eller skriv inn avdeling.");
        return;
      }
      localStorage.setItem("gb_dept", state.department);
      enterCounting();
    };

    $("#changeDept").onclick = ()=>{
      elStepCount.classList.add("hide");
      elStepDept.classList.remove("hide");
    };

    function enterCounting(){
      elDeptPill.textContent = "Avdeling: " + state.department;
      elStepDept.classList.add("hide");
      elStepCount.classList.remove("hide");
    }

    // ===== Add items =====
    $("#plus").onclick = ()=> elQty.value = Math.max(0, (+elQty.value||0) + 1);
    $("#minus").onclick = ()=> elQty.value = Math.max(0, (+elQty.value||0) - 1);

    $("#addItem").onclick = ()=>{
      const barcode = elBarcode.value.trim();
      const name = elName.value.trim();
      const qty = Math.max(0, +elQty.value || 0);

      if (!barcode && !name){
        alert("Oppgi strekkode eller varenavn.");
        return;
      }
      if (qty <= 0){
        alert("Antall m√• v√¶re st√∏rre enn 0.");
        return;
      }
      const id = crypto.randomUUID();
      const ts = new Date().toISOString();
      state.items.unshift({ id, barcode, name, qty, ts, dept: state.department });
      persist();
      clearInputs();
      renderList();
      try { navigator.vibrate && navigator.vibrate(18); } catch {}
    };

    function clearInputs(){
      elBarcode.value = "";
      elName.value = "";
      elQty.value = 1;
      elBarcode.focus();
    }

    function persist(){
      localStorage.setItem("gb_items", JSON.stringify(state.items));
    }

    function renderList(){
      elListBody.innerHTML = "";
      if (!state.items.length){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 4;
        td.className = "muted";
        td.textContent = "Ingen linjer enda.";
        tr.appendChild(td);
        elListBody.appendChild(tr);
        return;
      }
      state.items.forEach(item=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.barcode || "‚Äì"}</td>
          <td>${item.name || "‚Äì"}</td>
          <td>${item.qty}</td>
          <td style="text-align:right">
            <button data-id="${item.id}" class="btn" title="Slett">üóëÔ∏è</button>
          </td>
        `;
        tr.querySelector("button").onclick = (e)=>{
          const id = e.currentTarget.getAttribute("data-id");
          state.items = state.items.filter(x => x.id !== id);
          persist(); renderList();
        };
        elListBody.appendChild(tr);
      });
    }

    $("#clearAll").onclick = ()=>{
      if (!state.items.length) return;
      if (confirm("T√∏mme hele listen?")) {
        state.items = [];
        persist(); renderList();
      }
    };

    // ===== CSV export =====
    $("#exportCsv").onclick = ()=>{
      const rows = [
        ["department","timestamp","barcode","name","qty"]
      ];
      state.items.slice().reverse().forEach(i=>{
        rows.push([i.dept, i.ts, i.barcode || "", i.name || "", i.qty]);
      });
      const csv = rows.map(r => r.map(v => `"${String(v).replaceAll('"','""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = `varetelling_${(new Date()).toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    };

    // ===== Enkel skanning med BarcodeDetector (fallback = manuelt) =====
    const hasBD = "BarcodeDetector" in window;
    let stream = null, track = null, torchOn = false, scanning = false;

    $("#scanBtn").onclick = ()=>{
      if (!hasBD){
        alert("Kamera-skann st√∏ttes ikke i denne nettleseren. Bruk Android/Chrome, eller skriv inn strekkode manuelt.");
        return;
      }
      openScan();
    };
    $("#closeScan").onclick = closeScan;
    $("#torchBtn").onclick = toggleTorch;

    async function openScan(){
      $("#scanModal").style.display = "grid";
      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: "environment" }, width:{ideal:1280}, height:{ideal:720} }, audio:false
        });
        const video = $("#video");
        video.srcObject = stream; await video.play();
        track = stream.getVideoTracks()[0];
        scanning = true; detectLoop(video);
        // Torch hint
        const cap = track.getCapabilities?.() || {};
        $("#scanHint").textContent = cap.torch ? "Tips: sl√• p√• lommelykt ved behov." : "Tips: s√∏rg for godt lys.";
      } catch(err){
        alert("Kunne ikke √•pne kamera. Sjekk tillatelser/HTTPS.");
        closeScan();
      }
    }

    function closeScan(){
      $("#scanModal").style.display = "none";
      scanning = false; torchOn = false;
      if (stream) { stream.getTracks().forEach(t=>t.stop()); }
      stream = track = null;
    }

    async function toggleTorch(){
      if (!track?.applyConstraints) return;
      try{
        const cap = track.getCapabilities?.() || {};
        if (!cap.torch) { alert("Lommelykt ikke st√∏ttet."); return; }
        torchOn = !torchOn;
        await track.applyConstraints({ advanced: [{ torch: torchOn }] });
      } catch {}
    }

    async function detectLoop(video){
      const detector = new BarcodeDetector({ formats: ["ean_13","ean_8","upc_a","upc_e","code_128","qr_code"] });
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d", { willReadFrequently: true });
      while(scanning){
        if (video.readyState >= 2){
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0);
          const bitmap = await createImageBitmap(canvas);
          try{
            const codes = await detector.detect(bitmap);
            if (codes.length){
              const val = codes[0].rawValue;
              navigator.vibrate && navigator.vibrate(25);
              $("#barcode").value = val;
              closeScan();
              break;
            }
          } catch {}
        }
        await new Promise(r=>setTimeout(r, 140)); // ~7 skann/sek
      }
    }

    // ===== Minimal service worker (stille offline-st√∏tte) =====
    (async function registerSW(){
      if (!("serviceWorker" in navigator)) return;
      const code = `
        const C='gb-vt-1';
        self.addEventListener('install', e=>{e.waitUntil(caches.open(C).then(c=>c.addAll(['./']))); self.skipWaiting();});
        self.addEventListener('activate', e=> self.clients.claim());
        self.addEventListener('fetch', e=>{
          e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request).then(resp=>{
            const cp=resp.clone(); caches.open(C).then(c=>c.put(e.request, cp)).catch(()=>{});
            return resp;
          }).catch(()=>r)));
        });
      `;
      const blob = new Blob([code], {type:'text/javascript'});
      const url = URL.createObjectURL(blob);
      try{ await navigator.serviceWorker.register(url); }catch{}
    })();
  </script>
</body>
</html>
